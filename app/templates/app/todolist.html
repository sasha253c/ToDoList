{% extends "app/layout.html" %}

{% block content %}



<h2>{{ title }}</h2>
{#<h3>{{ message }}</h3>#}


<table id="tasks" class="table table-hover table-bordered table-striped">
    <thead>
        <tr>
            <th style="width:156px;">Status</th>
            <th>Name  <span class="glyphicon glyphicon-menu-right btn-sm" aria-hidden="true"></span></th>
            <th>Description  <span class="glyphicon glyphicon-menu-right btn-sm" aria-hidden="true"></span></th>
            <th>Date  <span class="glyphicon glyphicon-menu-right btn-sm" aria-hidden="true"></span></th>
            <th>Change  </th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr data-completed="{{ task.completed }}">
            <td><button id="{{ task.id }}" class="btn btn-primary btn-block" type="button">Do</button></td>
            <td>{{ task.name }}</td>
            <td>{{ task.description }}</td>
            <td>{{ task.date|date:'SHORT_DATE_FORMAT' }}</td>
            <td>
                <div class="btn-group btn-group-xs" role="group" aria-label="...">
                    <button type="button" class="btn btn-default">Change</button>
                    <button type="button" class="btn btn-default">Delete</button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<a href="{% url 'addtask' %}" class="btn btn-primary">Add</a>


{% endblock %}

{% block scripts %}

<script>

    $(document).ready(function () {

        $.ajaxSetup({

            beforeSend: function (xhr, settings) {
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie != '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

        $('#tasks tr').each(function () {
            if ($(this).data('completed') === 'True') success($(this))
            else notSuccess($(this));
        });

            
        
        var colDateNum = 2;
        $("#tasks").tablesorter(
            {
                headers: { colDateNum : { sorter: 'shortDate' } }
            }
        );

        $('#tasks th').click(function () {
            //Clear
            $('th').not(this).removeClass('bg-primary')
                   .children('span').removeClass('glyphicon-menu-up glyphicon-menu-down').addClass('glyphicon-menu-right');

            //Add
            $(this).addClass('bg-primary');

            if ($(this).children('span').hasClass('glyphicon-menu-down')) {
                $(this).children('span').removeClass("glyphicon-menu-down").addClass("glyphicon-menu-up");
            }
            else {
                $(this).children('span').removeClass("glyphicon-menu-up").addClass("glyphicon-menu-down");
            }
        });

        $('#tasks tbody tr td button').click(function () {
            var id = $(this).attr('id');
            var button = $(this);
            //alert(id);
            $.post('/change-completed/', { id: id }, function (data) {
                //alert(data.name);
                //alert(button.val());

                if (button.parent().parent().data('completed') === 'False') {
                    button.parent().parent().data('completed', 'True');
                    success(button.parent().parent());
                }
                else {
                    button.parent().parent().data('completed', 'False');
                    notSuccess(button.parent().parent());
                }
                //alert('end');
            });
        });

        function success(e) {
            e.addClass('success');

            var button = e.find('button').first();
            button.html('Done');
            button.removeClass('btn-primary');
            button.addClass('btn-success');
            
        }

        function notSuccess(e) {
            e.removeClass('success');

            var button = e.find('button').first();
            button.html('Do');
            button.removeClass('btn-success');
            button.addClass('btn-primary');
        }
    });

</script>

{% endblock %}
